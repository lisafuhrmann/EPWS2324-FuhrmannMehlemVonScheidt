<!-- Grundcode und Konzept von: https://technology.amis.nl/cloud/implementing-serverless-multi-client-session-synchronization-with-oracle-cloud-infrastructure/
* Author: Lucas Jellema
* GitHub: https://github.com/lucasjellema/live-cache/blob/main/index.html 
-->
<!DOCTYPE html>
<html>

<head>
    <script>
        const cacheServiceEndpoint = "https://ripe-mangos-super-smell.loca.lt/"

        let sessionKey;
        let member;
        let print = Math.random().toString(36).substring(7) + ''; //generiert einen print f端r den Client
        console.log("Das ist dein Print: " + print);
        const sessionRefreshIntervalDuration = 4000
        let sessionContextFreshInterval
        let inSession = false
        let messages = []

        // Funktion von Lucas Jellema
        // macht eine Post Request um eine neue Session zu starten
        const startSession = async () => {
            document.getElementById("sessionKey").innerText = ""
            const response = fetch(cacheServiceEndpoint,
                {
                    "method": "POST",
                    "mode": "cors",
                }
            )
            response.then(data => data.json()).then((json) => {
                console.log(json)
                sessionKey = JSON.stringify(json.body.sessionKey)
                console.log("new session initialized with key " + sessionKey)
                messages.length = 0;
                joinSession(sessionKey)
                pushSessionContext({ messages: messages })
                addPermission(document.getElementById("memberName").value)
            });
        }

        // Urfunktion von Lucas Jellema
        // tritt einer Session bei und macht eine Post Request um sich als Memeber der Grupper der Session hinzuzuf端gen
        const joinSession = async (sessionToJoinKey) => {
            member = document.getElementById("memberName").value
            sessionKey = sessionToJoinKey
            document.getElementById("sessionKey").innerText = sessionKey
            messages.length = 0;

            const requestOptions = {
                headers: { "Content-Type": "application/json" },
                method: "POST",
                mode: "cors",
                body: JSON.stringify({ fingerprint: print }),
            };
            fetch(cacheServiceEndpoint + "member" + "?sessionKey=" + sessionKey + "&member=" + member, requestOptions)

            sessionContextFreshInterval = setInterval(() => retrieveSessionContext(), sessionRefreshIntervalDuration)
            inSession = true
        }

        // f端gt einem Member berechtigung hinzu
        const addPermission = async (memberToGive) => {
            const requestOptions = {
                headers: { "Content-Type": "application/json" },
                method: "POST",
                mode: "cors",
                body: JSON.stringify({ fingerprint: print }),
            };
            fetch(cacheServiceEndpoint + "permission" + "?sessionKey=" + sessionKey + "&member=" + memberToGive, requestOptions)
        }

        // Funktion von Lucas Jellema
        // Macht eine Get Request um die Daten der Session zu erhalten
        const retrieveSessionContext = async () => {
            const requestOptions = {
                "method": "GET",
                "mode": "cors",
                "redirect": "follow"
            };

            fetch(cacheServiceEndpoint + "?sessionKey=" + sessionKey, requestOptions)
                .then(response => response.json())
                .then(result => processSessionContext(result))
                .catch(error => console.log('error', error));
        }

        // Funktion von Lucas Jellema
        // Macht eine Put Request um die Daten der Session zu updaten
        const pushSessionContext = async (sessionContext) => {
            const requestOptions = {
                headers: { "Content-Type": "application/json" },
                method: "PUT",
                mode: "cors",
                redirect: "follow",
                body: JSON.stringify({ value: sessionContext }),
            };
            console.log("PUT Request: " + requestOptions)

            fetch(cacheServiceEndpoint + "?sessionKey=" + sessionKey, requestOptions)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(result => console.log("Result of session context push: " + JSON.stringify(result.body)))
                .catch(error => console.log('error', error));
        }

        // Macht eine Put Request um die Daten der Session zu updaten
        const deleteSession = async () => {
            const requestOptions = {
                "method": "DELETE",
                "mode": "cors",
                "redirect": "follow"
            };

            fetch(cacheServiceEndpoint + "?sessionKey=" + sessionKey + "&print=" + print, requestOptions)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                })
        }

        // Funktion von Lucas Jellema
        // Verarbeitet die erhaltenen Daten der Session (hier um sie anzuzeigen)
        const processSessionContext = (sessionContext) => {
            const messagesTextarea = document.getElementById("messages")
            const memberTextarea = document.getElementById("members")
            console.log("Das hab ich bekommen: " + JSON.stringify(sessionContext))
            console.log("Das sagen die Leute: " + sessionContext.body.value)
            console.log("Das sind die Meber: " + sessionContext.memberBody.value)
            messages = sessionContext.body.value.messages
            members = sessionContext.memberBody.value
            const messageContent = messages.reduce((sum, message, index) => sum + (index > 0 ? "\n" : "") + message, "")
            const memberContent = members.reduce((sum, member, index) => sum + (index > 0 ? "\n" : "") + member, "")
            messagesTextarea.value = messageContent
            memberTextarea.value = memberContent
        }

        // Funktion von Lucas Jellema
        window.onload = function () {
            function initializePage() {
                document.getElementById("startSession").addEventListener("click", () => { startSession() })
                document.getElementById("joinSession").addEventListener("click", () => {
                    const joinSessionKey = document.getElementById("joinSessionKey").value
                    joinSession(joinSessionKey)
                })
                document.getElementById("sendMessage").addEventListener("click", () => {
                    const message = document.getElementById("message").value
                    messages.push(message)
                    pushSessionContext({ messages: messages })
                })
                document.getElementById("deleteSession").addEventListener("click", () => { deleteSession() })
            }

            initializePage();
        }
    </script>
</head>

<body>
    <label for="joinSessionKey">Session Key for Session To Join</label>
    <input id="joinSessionKey"></input>
    <label for="memberName">Name f端r die Session</label>
    <input id="memberName"></input>
    <input type="button" id="joinSession" value="Join Existing Multi Client Session" />
    <input type="button" id="startSession" value="Start Multi Client Session" />
    <input type="button" id="deleteSession" value="Delete current Session" />
    <h3>Multi Client Session Identifier <p id="sessionKey"></p>
    </h3>
    <hr />
    <label for="message">Message to Send</label>
    <input id="message" />
    <input type="button" id="sendMessage" value="Send Message" />
    <br />
    <textarea id="messages" rows="10" columns="80"></textarea>
    <textarea id="members" rows="10" columns="80"></textarea>
</body>

</html>